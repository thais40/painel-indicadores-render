# Atualiza o painel automaticamente todo dia às 7:00 (horário de Brasília)
name: Atualizar Painel Diário

on:
  schedule:
    - cron: '0 10 * * *'  # 10:00 UTC = 7:00 BRT
  workflow_dispatch:  # Permite executar manualmente

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Acordar painel e limpar cache
        run: |
          set -e
          URL="${{ secrets.RENDER_PANEL_URL }}"
          TOKEN="${{ secrets.REFRESH_TOKEN }}"
          
          if [ -z "$URL" ] || [ "$URL" = "" ]; then
            echo "::error::RENDER_PANEL_URL não configurado. Vá em Settings > Secrets > Actions e adicione."
            exit 1
          fi
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "" ]; then
            echo "::error::REFRESH_TOKEN não configurado. Vá em Settings > Secrets > Actions e adicione."
            exit 1
          fi
          
          URL="${URL%/}"
          FULL_URL="${URL}?refresh=${TOKEN}"
          echo "Chamando painel (aguarde até 2 min se Render estiver dormindo)..."
          
          CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" -L --max-time 120 "$FULL_URL" || echo "000")
          echo "HTTP Status: $CODE"
          
          if [ "$CODE" = "200" ]; then
            echo "Sucesso: cache limpo. Todos verão dados atualizados."
          else
            echo "::warning::Falhou. Verifique: (1) REFRESH_TOKEN no Render = REFRESH_TOKEN no GitHub (2) URL correta"
            exit 1
          fi
