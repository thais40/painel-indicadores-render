# Atualiza o painel automaticamente todo dia às 7:00 (horário de Brasília)
name: Atualizar Painel Diário

on:
  schedule:
    - cron: '0 10 * * *'  # 10:00 UTC = 7:00 BRT
  workflow_dispatch:  # Permite executar manualmente

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Acordar painel e limpar cache
        run: |
          URL="${{ secrets.RENDER_PANEL_URL }}"
          TOKEN="${{ secrets.REFRESH_TOKEN }}"
          
          if [ -z "$URL" ] || [ -z "$TOKEN" ]; then
            echo "::error::Configure REFRESH_TOKEN e RENDER_PANEL_URL em Settings > Secrets > Actions"
            exit 1
          fi
          
          URL="${URL%/}"
          FULL_URL="${URL}?refresh=${TOKEN}"
          echo "Chamando painel (aguarde até 2 min se Render estiver dormindo)..."
          
          for i in 1 2 3; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 120 "$FULL_URL" || echo "000")
            echo "Tentativa $i - HTTP Status: $CODE"
            
            if [ "$CODE" = "000" ]; then
              echo "Timeout ou sem conexão. Aguardando 25s..."
              sleep 25
            elif [ "$CODE" -ge 200 ] 2>/dev/null && [ "$CODE" -lt 400 ] 2>/dev/null; then
              echo "Sucesso: cache limpo (status $CODE)."
              exit 0
            elif [ "$CODE" -ge 500 ] 2>/dev/null && [ "$CODE" -le 599 ] 2>/dev/null; then
              echo "Servidor ocupado (5xx). Aguardando 25s..."
              sleep 25
            else
              echo "::warning::Status $CODE. Confira REFRESH_TOKEN no Render = GitHub e RENDER_PANEL_URL (sem barra no final)."
              exit 1
            fi
          done
          
          echo "::warning::Painel não respondeu após 3 tentativas. Pode estar dormindo no Render."
          exit 1
