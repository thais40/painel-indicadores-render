# Atualiza o painel automaticamente todo dia às 7:00 (horário de Brasília)
name: Atualizar Painel Diário

on:
  schedule:
    - cron: '0 10 * * *'  # 10:00 UTC = 7:00 BRT
  workflow_dispatch:  # Permite executar manualmente

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Acordar painel e limpar cache
        run: |
          URL="${{ secrets.RENDER_PANEL_URL }}"
          TOKEN="${{ secrets.REFRESH_TOKEN }}"
          
          if [ -z "$URL" ] || [ -z "$TOKEN" ]; then
            echo "::error::Configure REFRESH_TOKEN e RENDER_PANEL_URL em Settings > Secrets > Actions"
            exit 1
          fi
          
          URL="${URL%/}"
          FULL_URL="${URL}?refresh=${TOKEN}"
          echo "Chamando painel (aguarde até 2 min se Render estiver dormindo)..."
          
          for i in 1 2 3; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 120 "$FULL_URL" || echo "000")
            echo "Tentativa $i - HTTP Status: $CODE"
            
            case "$CODE" in
              200|301|302) echo "✓ Sucesso: cache limpo."; exit 0 ;;
              503|502|000) echo "Aguardando 25s (Render acordando)..."; sleep 25 ;;
              *) echo "::warning::Status $CODE - Verifique REFRESH_TOKEN e URL nos Secrets"; exit 1 ;;
            esac
          done
          
          echo "::warning::Painel não respondeu após 3 tentativas."
          exit 1
